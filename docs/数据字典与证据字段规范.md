# 数据库表结构与证据字段规范（v1）

## 1. 适用范围

- 数据库：SQLite（本地部署，后续可迁移到 PostgreSQL）。
- 版本：`/Users/xinghe/XingheAI2026/数字币/docs/sql/001_init.sql`
- 用途：当前满足内部查看，同时兼容后续司法/审计取证扩展。

## 2. 通用字段约束

- 所有时间字段使用 `Unix Epoch 秒`（UTC）。
- 主键 ID 统一用 `TEXT`（建议 UUID v7 / ULID）。
- 哈希字段统一用小写十六进制 SHA-256（长度 64）。
- JSON 字段统一存储为 UTF-8 文本。
- 逻辑删除暂不启用，删除依赖外键级联（`ON DELETE CASCADE`）。

## 3. 表说明

1. `cases`
- 作用：案件主表。
- 关键字段：`case_id`、`status`、`created_by`、`created_at`。

2. `case_devices`
- 作用：案件内设备清单（主机/手机/平板）。
- 关键字段：`os_type`、`identifier`、`is_authorized`。

3. `artifacts`
- 作用：原始采集证据（文件快照、命令输出、解析结果）。
- 关键字段：`artifact_type`、`snapshot_path`、`sha256`、`record_hash`。

4. `rule_bundles`
- 作用：规则包版本留痕（钱包签名库/交易所域名库）。

5. `rule_hits`
- 作用：规则命中结果（钱包安装、访问交易所等）。
- 关键字段：`hit_type`、`matched_value`、`confidence`、`verdict`。

6. `hit_artifact_links`
- 作用：命中与证据的多对多关联。

7. `audit_logs`
- 作用：采集与处理流程审计日志（含链式哈希）。

8. `reports`
- 作用：报告产物记录（内部报告/后续取证报告）。

## 4. 枚举定义

1. `os_type`
- `windows`
- `macos`
- `android`
- `ios`

2. `artifact_type`
- `installed_apps`
- `browser_history`
- `browser_extension`
- `mobile_packages`
- `mobile_backup`

3. `hit_type`
- `wallet_installed`
- `exchange_visited`
- `wallet_address`（后续）
- `token_balance`（后续）

4. `verdict`
- `confirmed`
- `suspected`
- `unsupported`

5. `audit_logs.status`
- `started`
- `success`
- `failed`
- `skipped`

## 5. 证据字段规范（artifacts）

1. 必填字段
- `artifact_id`
- `case_id`
- `device_id`
- `artifact_type`
- `snapshot_path`
- `sha256`
- `size_bytes`
- `collected_at`
- `collector_name`
- `collector_version`
- `record_hash`
- `created_at`

2. 字段语义
- `source_ref`：原始来源引用，如 `C:\Users\...\History` 或 `adb shell pm list packages`。
- `snapshot_path`：采集后固化副本路径（推荐只读目录）。
- `sha256`：`snapshot_path` 文件内容哈希。
- `payload_json`：从原始证据提取的结构化内容，避免把原文当 JSON 覆盖。
- `record_hash`：证据元数据哈希（见第 6 节）。
- `acquisition_method`：采集方式，如 `file_copy`、`command_exec`、`backup_extract`。

3. 写入规则
- 先落盘快照，再计算 `sha256`，最后入库。
- 若快照不存在或哈希长度不为 64，禁止入库。
- `size_bytes` 与实际文件大小必须一致。
- 同一 `artifact_id` 不可重写；更新必须新建记录。

## 6. 哈希与链路留痕规范

1. `artifacts.record_hash` 计算
- 用以下字段按固定顺序拼接后做 SHA-256。
- 拼接顺序：
  - `artifact_id`
  - `case_id`
  - `device_id`
  - `artifact_type`
  - `source_ref`（空值用空字符串）
  - `snapshot_path`
  - `sha256`
  - `size_bytes`
  - `collected_at`
  - `collector_name`
  - `collector_version`
  - `payload_json`（需 canonical JSON，键排序、无多余空白）

2. `audit_logs.chain_hash` 计算
- `chain_prev_hash` 取同 `case_id` 上一条审计事件的 `chain_hash`。
- 第一条事件 `chain_prev_hash` 为空字符串。
- 当前条 `chain_hash = SHA256(chain_prev_hash + '\n' + case_id + '\n' + event_type + '\n' + action + '\n' + status + '\n' + occurred_at + '\n' + detail_json_canonical)`

3. 校验规则
- 每次生成报告前执行链路完整性校验。
- 如发现断链，报告状态标记为 `failed` 并记录异常事件。

## 7. 命中结果规范（rule_hits）

1. `confidence`
- 取值区间 `[0,1]`。
- 建议阈值：
  - `>= 0.85` 高可信
  - `0.60 - 0.84` 中可信
  - `< 0.60` 低可信

2. `first_seen_at` / `last_seen_at`
- 单证据命中可相同。
- 多证据合并命中时分别取最早与最晚时间。

3. `detail_json`
- 推荐字段：`rule_source`、`matched_field`、`match_mode`、`notes`。

## 8. 报告字段最小集（reports）

- `report_id`
- `case_id`
- `report_type`
- `file_path`
- `sha256`
- `generated_at`
- `generator_version`
- `status`

建议内部报告至少展示：
- 设备清单与授权状态
- 钱包安装命中
- 交易所访问命中
- 未采集项及原因（权限/系统限制）
- 证据条目与哈希

## 9. 后续取证升级建议（不影响当前建表）

1. 新增 `evidence_signatures` 表
- 存储签名算法、签名值、签名证书指纹。

2. 新增 `chain_verifications` 表
- 保存每次链完整性校验结果与时间。

3. 新增 `legal_exports` 表
- 管理司法导出包（ZIP/PDF/清单）的生成与交付记录。
