# 发布与签名（CI + 本地）

本项目优先满足“内网/内部试用”的可用闭环；对外发版时建议启用代码签名与（macOS）notarization。

## 1) 自动发布（GitHub Actions）

当推送 tag（`v*`）到 GitHub：

- `.github/workflows/build-installers.yml` 会自动构建：
  - macOS：DMG + PKG
  - Windows：Inno Setup 安装器 EXE
- 并自动创建 GitHub Release，上传安装器附件与 `SHA256SUMS.txt`

示例：

```bash
git tag v0.1.2
git push origin v0.1.2
```

## 2) 本地构建安装器

macOS（DMG/PKG）：

```bash
VERSION=0.1.2 bash scripts/package_macos_installer.sh
```

Windows（Inno Setup）：

```powershell
bash scripts/package_bundle.sh
"C:\\Program Files (x86)\\Inno Setup 6\\ISCC.exe" installer\\windows\\crypto-trace-inspector.iss
```

## 3) macOS 代码签名与公证（可选）

脚本 `scripts/package_macos_installer.sh` 支持在环境变量存在时自动签名/公证：

- `MACOS_CODESIGN_IDENTITY`：用于 `codesign`（Developer ID Application）
- `MACOS_PKG_SIGN_IDENTITY`：用于 `pkgbuild --sign`（Developer ID Installer，可选）
- `MACOS_NOTARY_KEYCHAIN_PROFILE`：用于 `xcrun notarytool submit --keychain-profile ...`（可选）

示例（本地）：

```bash
export MACOS_CODESIGN_IDENTITY="Developer ID Application: Your Company (TEAMID)"
export MACOS_PKG_SIGN_IDENTITY="Developer ID Installer: Your Company (TEAMID)"
export MACOS_NOTARY_KEYCHAIN_PROFILE="notarytool-profile-name"

VERSION=0.1.2 bash scripts/package_macos_installer.sh
```

说明：

- notarization 需要你先用 `xcrun notarytool store-credentials ...` 创建 keychain profile。
- 没有上述变量时，脚本会跳过签名/公证（仍可用于内部试用）。

## 4) Windows 代码签名（待接入）

Windows 代码签名需要证书与 `signtool`/CI secrets。建议在确定证书来源与安全策略后，再接入到 CI 流水线中（避免把私钥暴露到构建环境）。

