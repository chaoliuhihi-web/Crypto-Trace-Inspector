# 项目目录结构与模块接口定义（v1）

## 1. 目标与范围

- 主机端：Windows 优先，兼容 macOS。
- 被检设备：PC 本机、Android（ADB 授权）、iOS（信任配对+备份授权）。
- 当前版本：先满足内部排查。
- 架构要求：从第一版开始保留取证扩展能力（原始证据、哈希、采集链路日志）。

## 2. 推荐技术栈

- 语言：Go 1.23+
- 桌面壳：Wails v2（跨 Windows/macOS）
- 本地数据库：SQLite（WAL 模式）
- Android 接入：ADB CLI
- iOS 接入：libimobiledevice 工具链
- 日志：zap（JSON 结构化）

## 3. 目录结构（可直接创建）

```text
crypto-inspector/
  cmd/
    inspector-desktop/
      main.go                     # 应用入口（Wails 启动）
    inspector-cli/
      main.go                     # CLI 入口（批量/自动化采集）

  internal/
    app/
      bootstrap.go                # 依赖注入与模块组装

    domain/
      model/
        case.go                   # 案件、目标、设备等核心实体
        device.go
        evidence.go
        rule.go
        report.go
      value/
        hash.go                   # Hash 类型与校验
        confidence.go             # 置信度枚举

    ports/
      host_probe.go               # 主机探测接口（Win/macOS）
      mobile_connector.go         # 移动设备连接与授权接口
      collector.go                # 证据采集接口
      rule_engine.go              # 规则匹配接口
      evidence_store.go           # 证据存储接口
      report_builder.go           # 报告生成接口
      audit_log.go                # 审计日志接口
      chain_provider.go           # （后续）链上余额查询接口

    services/
      detection_service.go        # 总编排：连接 -> 采集 -> 规则 -> 入库 -> 报告
      host_scan_service.go        # 主机检测工作流
      mobile_scan_service.go      # 移动端检测工作流
      report_service.go           # 报告组装

    adapters/
      host/
        windows/
          installed_apps.go       # 注册表/程序列表采集
          browser_history.go      # Chrome/Edge/Firefox 历史采集
          extensions.go           # 浏览器钱包扩展识别
        macos/
          installed_apps.go       # /Applications、LaunchServices
          browser_history.go      # Safari/Chrome/Firefox 历史采集
          extensions.go

      mobile/
        android/
          adb_connector.go        # 设备发现/授权检测
          packages_collector.go   # 包名/应用列表采集
          browser_artifacts.go    # 可访问浏览痕迹采集（受限）
        ios/
          idevice_connector.go    # 配对/备份状态检查
          backup_collector.go     # 备份中可用数据提取
          app_inventory.go        # 应用清单解析

      rules/
        matcher.go                # 钱包/交易所规则匹配实现
        loader.go                 # 规则加载（YAML/JSON）

      store/
        sqlite/
          migrations/
            001_init.sql
            002_evidence_chain.sql
          case_repo.go
          evidence_repo.go
          audit_repo.go

      report/
        internal_html.go          # 内部可视化报告
        internal_json.go          # 内部结构化报告
        forensic_pdf.go           # 后续取证格式

      audit/
        logger.go                 # 采集行为审计日志

    platform/
      exec/
        runner.go                 # 外部命令执行封装（adb/idevice/系统工具）
      fs/
        snapshot.go               # 原始文件快照与hash
      time/
        clock.go

  configs/
    app.yaml

  rules/
    wallet_signatures.yaml        # 钱包软件特征库
    exchange_domains.yaml         # 交易所域名库

  docs/
    项目目录结构与模块接口.md
    数据字典与证据链规范.md

  scripts/
    dev_run.sh
    release_build.sh

  tests/
    e2e/
      host_scan_test.go
      android_scan_test.go
      ios_scan_test.go
```

## 4. 核心领域模型（最小集）

```go
package model

type OSType string

const (
    OSWindows OSType = "windows"
    OSMacOS   OSType = "macos"
    OSAndroid OSType = "android"
    OSIOS     OSType = "ios"
)

type Device struct {
    ID          string
    Name        string
    OS          OSType
    Identifier  string // 序列号/UDID/主机指纹
    IsConnected bool
}

type ArtifactType string

const (
    ArtifactInstalledApps   ArtifactType = "installed_apps"
    ArtifactBrowserHistory  ArtifactType = "browser_history"
    ArtifactBrowserExt      ArtifactType = "browser_extension"
    ArtifactMobilePackages  ArtifactType = "mobile_packages"
    ArtifactMobileBackup    ArtifactType = "mobile_backup"
)

type RawArtifact struct {
    ID          string
    CaseID      string
    DeviceID    string
    Type        ArtifactType
    SourcePath  string // 原始位置（文件/命令来源）
    SnapshotPath string // 采集后快照路径
    SHA256      string
    CollectedAt int64
    Collector   string // collector name + version
    Payload     []byte
}

type HitType string

const (
    HitWalletInstalled HitType = "wallet_installed"
    HitExchangeVisited HitType = "exchange_visited"
)

type RuleHit struct {
    ID          string
    CaseID      string
    DeviceID    string
    HitType     HitType
    RuleID      string
    RuleVersion string
    Value       string // 包名/域名/扩展ID
    FirstSeenAt int64
    LastSeenAt  int64
    Confidence  string // high/medium/low
    EvidenceIDs []string
}
```

## 5. 模块接口定义（ports）

```go
package ports

import (
    "context"
    "crypto-inspector/internal/domain/model"
)

type HostProbe interface {
    DetectHost(ctx context.Context) (model.Device, error)
    CheckPrerequisites(ctx context.Context, host model.Device) ([]string, error)
}

type MobileConnector interface {
    ListConnected(ctx context.Context) ([]model.Device, error)
    VerifyAuthorization(ctx context.Context, device model.Device) (bool, []string, error)
}

type Collector interface {
    Name() string
    Supports(device model.Device) bool
    Collect(ctx context.Context, caseID string, device model.Device) ([]model.RawArtifact, error)
}

type RuleEngine interface {
    Match(ctx context.Context, device model.Device, artifacts []model.RawArtifact) ([]model.RuleHit, error)
    RuleVersion(ctx context.Context) string
}

type EvidenceStore interface {
    SaveArtifacts(ctx context.Context, artifacts []model.RawArtifact) error
    SaveHits(ctx context.Context, hits []model.RuleHit) error
    GetCaseArtifacts(ctx context.Context, caseID string) ([]model.RawArtifact, error)
    GetCaseHits(ctx context.Context, caseID string) ([]model.RuleHit, error)
}

type AuditLogger interface {
    LogAction(ctx context.Context, caseID string, deviceID string, action string, detail map[string]any) error
}

type ReportBuilder interface {
    BuildInternal(ctx context.Context, caseID string) ([]byte, error) // html/json
    BuildForensic(ctx context.Context, caseID string) ([]byte, error) // 后续扩展
}

type ChainBalanceProvider interface {
    QueryBalances(ctx context.Context, addresses []string) (map[string]map[string]string, error)
    // return: address -> tokenSymbol -> amount
}
```

## 6. 编排服务接口（services）

```go
package services

import (
    "context"
    "crypto-inspector/internal/domain/model"
)

type DetectionService interface {
    StartCase(ctx context.Context, operatorID string, note string) (caseID string, err error)
    ScanHost(ctx context.Context, caseID string) (device model.Device, hitCount int, err error)
    ScanMobiles(ctx context.Context, caseID string) (scanned int, hitCount int, err error)
    GenerateInternalReport(ctx context.Context, caseID string) (reportPath string, err error)
}
```

## 7. 采集器最小清单（MVP）

- Host collectors
  - Windows 安装应用采集器（注册表 + 常见安装路径）
  - Windows 浏览器历史采集器（Chrome/Edge/Firefox）
  - macOS 安装应用采集器（/Applications + 用户目录）
  - macOS 浏览器历史采集器（Safari/Chrome/Firefox）
  - 浏览器扩展采集器（MetaMask 等）
- Mobile collectors
  - Android 包名采集器（`adb shell pm list packages`）
  - iOS 应用清单采集器（配对后读取）
  - iOS 备份元数据采集器（可提取时）

## 8. 规则库结构（示例）

```yaml
# rules/wallet_signatures.yaml
version: "2026-02-12"
wallets:
  - id: "wallet_metamask"
    name: "MetaMask"
    package_names: ["io.metamask", "io.metamask.app"]
    browser_extensions:
      - chrome: "nkbihfbeogaeaoehlefnkodbefgpgknn"
    desktop_keywords: ["metamask", "MetaMask"]

  - id: "wallet_imtoken"
    name: "imToken"
    package_names: ["im.token.app"]
    desktop_keywords: ["imtoken", "imToken"]
```

```yaml
# rules/exchange_domains.yaml
version: "2026-02-12"
exchanges:
  - id: "binance"
    domains: ["binance.com", "www.binance.com"]
  - id: "okx"
    domains: ["okx.com", "www.okx.com"]
  - id: "htx"
    domains: ["htx.com", "www.htx.com", "huobi.com"]
```

## 9. 开发顺序（与目录/接口对齐）

1. 建 `domain + ports + sqlite migrations`，固定数据模型。
2. 先实现 `adapters/host/windows + adapters/host/macos`，打通主机检测闭环。
3. 再接 `android adb_connector + packages_collector`。
4. 再接 `ios idevice_connector + app_inventory`。
5. 最后做报告模板与规则库在线更新。

## 10. 对“后续链上余额”预留点

- 当前只预留 `ChainBalanceProvider` 接口，不在 MVP 强行实现。
- 后续流程：从命中证据中提取地址 -> 调区块链节点/API -> 生成余额快照并与证据链绑定。
