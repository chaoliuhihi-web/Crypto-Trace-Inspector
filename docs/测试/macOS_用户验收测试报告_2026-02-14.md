# macOS 用户验收测试报告（2026-02-14）

结论：主闭环可用（建案 -> 采集 -> 命中/证据 -> 审计 -> 报告 -> 导出 ZIP/PDF -> 离线校验）。macOS 安装器（DMG/PKG）可构建；`.app` 启动可用；签名/公证未启用（内部试用阶段符合预期）。

本报告不包含真实证据内容与个人数据；仅记录“可复现的命令、结果与结论”。

---

## 1. 测试环境

- OS：macOS 26.2（arm64，Build 25C56）
- Go：`go1.24.0 darwin/arm64`
- Node：`v22.22.0`
- npm：`10.9.4`

## 2. 仓库信息

- 分支：`main`
- 提交：`1dc133b`（`1dc133b6ad36070af427a86c4469bf20d710fa04`）

## 3. 覆盖范围

自动化（必跑）：

- `go test ./...`
- `bash scripts/e2e.sh`（Playwright 用户视角：建案 -> 采集 -> 规则导入 -> 证据下载 -> 导出 -> verify）

安装包/启动（macOS）：

- `bash scripts/package_macos_installer.sh`（产出 `.app` + DMG + PKG）
- `.app` 启动冒烟：`/api/health` + 日志落盘
- DMG 挂载结构检查
- PKG payload 与签名状态检查（内部试用阶段允许 unsigned）

Bundle（解压即用）：

- `bash scripts/package_bundle.sh`（产出 `dist/crypto-inspector-darwin-arm64/`）
- `inspector-desktop --ui none` 启动冒烟：`/api/health`

未覆盖（需外部条件/设备）：

- Android 真机采集差异（ROM/权限/浏览 provider）
- iOS 真机备份差异（加密备份/版本差异）
- Windows 真机安装器完整验收（开始菜单/升级覆盖/杀软/SmartScreen）

## 4. 执行记录与结果

### 4.1 单测

命令：

```bash
go test ./...
```

结果：PASS

### 4.2 E2E（Playwright）

命令：

```bash
bash scripts/e2e.sh
```

覆盖点（本次 E2E 已包含）：

- API 规则导入并启用：`POST /api/rules?action=import`（wallet/exchange）
- UI 建案
- UI 触发采集（仅主机）
- API 证据下载：`GET /api/artifacts/{artifact_id}/download`
- API 证据复核：`POST /api/cases/{case_id}/verify/artifacts`
- API 审计强校验：`POST /api/cases/{case_id}/verify/audits`
- API internal 报告内容读取：`GET /api/cases/{case_id}/report?report_id=...&content=true`
- UI 生成取证 PDF
- UI 生成司法导出 ZIP
- CLI 离线校验导出包：`verify forensic-zip`

结果：PASS

关键校验摘要（来自 E2E 输出）：

- forensic zip verify：`failed=0`
- audit chain verify：`prev_hash_failed=0` 且 `chain_hash_failed=0`

产物位置（本机）：

- Playwright HTML 报告：`output/playwright/report/`
- trace/screenshot/video：`output/playwright/test-output/`
- E2E 临时数据：`output/e2e/`

### 4.3 macOS 安装器构建（DMG/PKG）

命令（示例版本号）：

```bash
VERSION=0.1.0-uat2 bash scripts/package_macos_installer.sh
```

结果：PASS（产出 `.app` + `.dmg` + `.pkg`）

本次验证产物（示例）：

- `dist/installers/macos/CryptoTraceInspector-0.1.0-uat2-macos-universal.dmg`
- `dist/installers/macos/CryptoTraceInspector-0.1.0-uat2-macos-universal.pkg`

SHA256（示例）：

- DMG：`31e9aa06ab56c657868b416b7982228b0d5a439dd6da4016b6f9c0ac1f8b3403`
- PKG：`d634e6864fe25755e629c0cf7076d7c9a09e7c4161ca8370cefb4d0d8470fdb5`

### 4.4 DMG 结构检查

命令：

```bash
hdiutil attach -nobrowse -readonly dist/installers/macos/*.dmg
ls -la /Volumes/CryptoTraceInspector
hdiutil detach /Volumes/CryptoTraceInspector
```

结果：PASS

- DMG 根目录包含：
  - `CryptoTraceInspector.app`
  - `Applications -> /Applications`（拖拽安装）

### 4.5 PKG payload / 签名状态检查

命令：

```bash
pkgutil --payload-files dist/installers/macos/*.pkg | rg "CryptoTraceInspector\\.app" | head
pkgutil --check-signature dist/installers/macos/*.pkg
```

结果：PASS

- payload 包含 `./Applications/CryptoTraceInspector.app/...`
- 签名状态：`no signature`（符合预期：内部试用未配置签名证书）

### 4.6 `.app` 启动冒烟（用户角度：双击打开）

目标：验证 App 能启动本地服务并可访问 UI（webview 或 browser）。

验证方式（不依赖人工点击）：

- 启动 `.app` 后访问：`http://127.0.0.1:8787/api/health`
- 检查日志文件：`~/Library/Application Support/Crypto-Trace-Inspector/logs/inspector-desktop.log`

结果：PASS

备注（本次修复项）：

- 修复了 `.app` 启动脚本在某些环境下误选 x86_64 `bash`（Rosetta/双 Homebrew）导致 `--ui webview` 不可用的问题：
  - 改为使用 `#!/bin/bash`
  - Apple Silicon / Rosetta 优先使用 `webview` 并尝试 `arch -arm64` 强制 arm64 slice
  - Intel 环境降级为 `browser`（仍可用）

对应代码生成位置：

- `scripts/package_macos_installer.sh`（生成 `.app/Contents/MacOS/<APP_NAME>` 启动器脚本）

### 4.7 Bundle（解压即用）启动冒烟

命令（示例）：

```bash
VERSION=0.1.0-uat2 bash scripts/package_bundle.sh
dist/crypto-inspector-darwin-arm64/inspector-desktop --ui none --no-open --listen 127.0.0.1:8793 ...
curl -fsS http://127.0.0.1:8793/api/health
```

结果：PASS

---

## 5. 对照用例覆盖情况

对照：`docs/测试/macOS_用户验收测试用例.md`

- MAC-UAT-01：PASS（已构建 DMG/PKG；`.app` 启动与 health 验证通过；拖拽安装步骤未做强制依赖）
- MAC-UAT-02：PASS
- MAC-UAT-03：PASS（bundle 启动冒烟通过）
- MAC-UAT-10：PASS（由 Playwright 覆盖）
- MAC-UAT-11：PASS（由 Playwright 覆盖）
- MAC-UAT-12：未执行（需要无设备场景下手工观察提示；后续建议补一条 E2E 或手工用例）
- MAC-UAT-20：部分覆盖（E2E 已覆盖 API 下载；UI 表格手工下载未验）
- MAC-UAT-21：PASS（E2E 已覆盖 internal_html/internal_json 内容读取）
- MAC-UAT-22：PASS（由 Playwright 覆盖）
- MAC-UAT-23：PASS（由 Playwright 覆盖 + CLI verify）
- MAC-UAT-30：PASS（由 Playwright 覆盖）
- MAC-UAT-40：未执行（可后续补一条 UI 上传测试；当前已通过 API import 验证核心链路）

## 6. 已知风险与建议

- 安装器签名/公证尚未启用：对外分发时需要接入 `codesign/notarytool`（macOS）与 Windows 代码签名。
- 移动端采集的兼容性高度依赖设备/权限策略，需要真机覆盖验证（见 `TODOLIST.md` 的 V2/V3）。
