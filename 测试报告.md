# 测试报告（内部试用版）

生成时间：2026-02-14  
仓库版本：git HEAD（以 `git log -1` 为准）  

本报告用于记录当前仓库在“内部试用/内网部署”场景下的功能覆盖与验证结果（不包含个人数据与真实证据内容）。

---

## 1. 测试环境

- OS：macOS（Darwin 25.2.0，arm64）
- Go：`go1.24.0 darwin/arm64`
- Node：`v22.22.0`（npm `10.9.4`）

---

## 2. 已验证范围（PASS）

### 2.1 编译与单测

- `go test ./...`：PASS
- 前端构建：`bash scripts/build_ui.sh`：PASS（产物已拷贝到 `internal/services/webapp/ui_dist/` 并可被 `go:embed` 打包）

### 2.2 桌面启动器（Desktop Launcher）

目标：降低门槛，一键启动本地 WebUI/API，并自动打开浏览器。

- 入口：`cmd/inspector-desktop`
- 验证点：
  - 能启动 Web 服务并监听 `--listen`
  - `GET /api/health` 返回 `{"ok":true,...}`
  - `--no-open` 可关闭自动打开浏览器（便于测试/CI）
  - `--ui` 支持：
    - `browser`：打开系统浏览器（默认）
    - `webview`：内嵌窗口（仅 macOS+cgo 可用，依赖系统 WebKit）
    - `none`：不打开 UI（仅启动服务）

### 2.3 Web API（核心）

已覆盖接口：

- 健康检查：`GET /api/health`
- 元信息：`GET /api/meta`
- 规则管理：`GET/POST /api/rules`（`action=import|activate`）
- 案件管理：`GET/POST /api/cases`
- 案件聚合信息：`GET /api/cases/{case_id}/overview`
- 设备列表：`GET /api/cases/{case_id}/devices`
- 命中列表：`GET /api/cases/{case_id}/hits`（支持 `?hit_type=`）
- 证据列表：`GET /api/cases/{case_id}/artifacts`
- 审计：`GET /api/cases/{case_id}/audits`
- 前置检查：`GET /api/cases/{case_id}/prechecks`
- 报告：`GET /api/cases/{case_id}/reports`、`GET /api/cases/{case_id}/report?content=true`、`GET /api/reports/{report_id}/download`
- 证据下载：`GET /api/artifacts/{artifact_id}/download`
- 证据快照哈希复核：`POST /api/cases/{case_id}/verify/artifacts`
- 审计链强校验（重算 chain_hash）：`POST /api/cases/{case_id}/verify/audits`
- 司法导出包（ZIP）：`POST /api/cases/{case_id}/exports/forensic-zip`
- 取证 PDF：`POST /api/cases/{case_id}/exports/forensic-pdf`
- 链上余额（即时查询）：
  - `POST /api/chain/evm/balances`（eth_getBalance）
  - `POST /api/chain/evm/erc20/balances`（ERC20 balanceOf）
  - `POST /api/chain/btc/balances`（BTC address API）
- 链上余额（查询并留痕写入案件）：
  - `POST /api/cases/{case_id}/chain/balance`（写入 `chain_balance` artifact + `token_balance` 命中）

### 2.3.1 规则管理（导入/切换）

目标：在不重启服务的情况下，导入新规则并让“下一次扫描”使用新规则。

验证点：

- `GET /api/rules` 返回：
  - 当前 active 的 wallet/exchange 规则路径
  - 可用规则文件列表（默认模板 + data/rules 下的导入文件）
- `POST /api/rules?action=import`：
  - 上传 YAML 文本后会保存到 `data/.../rules/`，并设置为 active
  - 同时执行规则校验（wallet/exchange 成对校验）
- `POST /api/rules?action=activate`：
  - 切换 active 路径，并在下一次扫描中生效

### 2.4 主机采集（Host Scan）

命令（示例）：

```bash
go run ./cmd/inspector-cli migrate --db data/e2e/inspector.db
go run ./cmd/inspector-cli scan host \
  --db data/e2e/inspector.db \
  --evidence-dir data/e2e/evidence \
  --operator tester \
  --auth-order E2E-ORDER-001
```

验证点：

- 生成证据（artifacts）并落盘快照：`installed_apps` / `browser_extension` / `browser_history`
- 字段补齐（P1-09）：
  - `installed_apps`：
    - Windows：InstallDate/UninstallString/DisplayIcon（best effort）
    - macOS：BundleID/版本号（解析 Info.plist，best effort）
  - `browser_extension`：name/version/path（Chrome/Edge 解析 manifest.json；Firefox 解析 extensions.json，best effort）
- P1 增强（已接入）：浏览历史原始库快照 `browser_history_db`（zip，包含 db + -wal/-shm，best effort）
- 规则匹配生成命中（rule_hits）：
  - `wallet_installed`
  - `exchange_visited`
  - `wallet_address`（从浏览历史 URL/title 抽取 0x… / bc1… / 1…/3…）
- 生成内部报告（自动生成两份）：
  - `internal_json`
  - `internal_html`
- 审计链写入：`audit_logs` 形成链式 hash

### 2.5 移动端采集（Mobile Scan）

验证点（无设备时）：

- 未连接设备时：
  - `require-authorized=false`：流程不强制失败，precheck 会记录 “未检测到可采集设备”
  - `require-authorized=true`：会失败并给出明确原因

采集能力（best effort）：

- Android：
  - ADB 设备识别 + `pm list packages` 应用包清单（需要 USB 调试授权）
  - 浏览历史（best effort）：`adb shell content query` 尝试读取可达的浏览 provider；若系统限制/权限拒绝，会落 `precheck=skipped` 并记录原因与尝试细节（供 UI 展示）
- iOS：
  - 配对验证 + 应用清单 + 可选 `idevicebackup2` 全量备份（需要信任/配对/备份授权）
  - 备份解析（best effort）：在备份可读前提下，尝试从 `Manifest.db` 定位 Safari/Chrome 的 History DB 并解析为 `browser_history` artifact（不做破解/绕过）
  - 随后可触发 `exchange_visited` 与 `wallet_address` 命中（需真机验证）

### 2.6 司法导出包（ZIP）+ 离线校验（verify）

导出（示例）：

```bash
go run ./cmd/inspector-cli export forensic-zip \
  --db data/e2e/inspector.db \
  --case-id <CASE_ID> \
  --operator tester \
  --note "e2e zip"
```

ZIP 内容要点：

- `manifest.json`：案件、设备、证据、命中、前置检查、审计、报告、文件清单
- `hashes.sha256`：对 ZIP 内文件（不含自身）生成 sha256sum 兼容清单（允许 `#` 注释头）
- `evidence/`：证据快照文件（常见为 `.json`；P1 增强的原始库快照为 `.zip`）
- `reports/`：报告产物文件（包含 internal_json/internal_html/forensic_pdf 等；不包含 forensic_zip 本身）
- `rules/`：规则文件

离线校验（示例）：

```bash
go run ./cmd/inspector-cli verify forensic-zip \
  --zip data/e2e/exports/<ZIP_NAME>.zip
```

验证点：

- 校验通过时返回：`failed=0`
- 篡改 ZIP 内任意文件后可定位到具体路径并返回失败

### 2.7 取证 PDF 报告（forensic_pdf）

导出（示例）：

```bash
go run ./cmd/inspector-cli export forensic-pdf \
  --db data/e2e/inspector.db \
  --case-id <CASE_ID> \
  --operator tester \
  --note "e2e pdf"
```

验证点：

- 生成 PDF 文件并登记到 `reports` 表
- `sha256` 入库可追溯
- 若环境缺少 UTF-8 字体，会输出 warning（不阻断导出）

### 2.8 证据快照 SHA256 复核（verify artifacts）

CLI（示例）：

```bash
go run ./cmd/inspector-cli verify artifacts \
  --db data/e2e/inspector.db \
  --case-id <CASE_ID>
```

验证点：

- `ok=total` 时表示证据目录未被篡改/丢失（至少从 sha256/size 角度一致）
- 人为改动快照文件可触发 mismatch（后端 API/UI 也支持）

### 2.8.1 审计链强校验（verify audits）

API（示例）：

```bash
curl -sS -X POST "http://127.0.0.1:8080/api/cases/<CASE_ID>/verify/audits" \
  -H "Content-Type: application/json" \
  -d '{"operator":"tester","note":"e2e audit verify","limit":5000}'
```

CLI（示例）：

```bash
go run ./cmd/inspector-cli verify audits \
  --db data/e2e/inspector.db \
  --case-id <CASE_ID>
```

验证点：

- 校验 `chain_prev_hash` 连续性
- 重算 `chain_hash` 并与存量字段对比
- 若 forensic zip 内存在 `manifest.json`，`verify forensic-zip` 会额外强校验 `manifest.audits`

### 2.9 链上余额查询（即时查询 + 留痕）

即时查询（UI / API）：

- EVM 原生币：`/api/chain/evm/balances`
- EVM ERC20：`/api/chain/evm/erc20/balances`
- BTC：`/api/chain/btc/balances`

留痕写入案件（UI 按钮“查询并留痕” / API）：

- `POST /api/cases/{case_id}/chain/balance`
- 写入结果：
  - `artifacts.artifact_type=chain_balance`
  - `rule_hits.hit_type=token_balance`（并关联 artifact）
- 司法导出 ZIP 的 `manifest.json` 可追溯以上内容

### 2.10 隐私开关 masked（展示层脱敏）

目标：对外展示/演示材料时隐藏敏感信息（路径/URL/地址），但不破坏“原始证据快照”的可复核性。

验证点（Host Scan）：

- 使用 `--privacy-mode masked` 扫描后：
  - internal_json/internal_html 报告中：
    - `artifacts[].snapshot_path` 被压缩为文件名（不暴露用户名与绝对路径）
    - `wallet_address`/`token_balance` 命中的地址值做部分隐藏（保留头尾）

### 2.11 E2E 自动化（Playwright）

目标：自动回归“建案 -> 采集 -> 导出 -> 校验”的主闭环（不依赖真机）。

命令（在仓库根目录执行）：

```bash
bash scripts/e2e.sh
```

覆盖点（smoke 用例）：

- UI 建案（`01 案件信息` -> `[新建案件]`）
- UI 触发采集（仅勾选主机，避免移动端前置条件导致不稳定）
- API 证据快照复核：`POST /api/cases/{case_id}/verify/artifacts`
- API 审计链强校验：`POST /api/cases/{case_id}/verify/audits`
- UI 生成取证 PDF
- UI 生成司法导出包（ZIP）
- CLI 离线校验导出包：`verify forensic-zip`

产物：

- Playwright 报告：`output/playwright/report/`
- 运行数据（临时）：`output/e2e/`
  - artifacts 原始快照文件不被修改（仍可在证据管理中下载复核）

---

## 3. 未完成 / 需外部条件验证（TODO）

### 3.1 Android 移动端“交易所访问”采集

- 已实现 Android 浏览历史 best effort 采集（content provider 尝试 + precheck 留痕），但是否能真正采到 URL 取决于 ROM/权限策略：
  - 若 provider 可达：会落 `browser_history` artifact，并可触发 `exchange_visited` 命中
  - 若被系统限制：会落 `precheck=skipped` 并输出明确原因（不做破解/绕过）

### 3.2 iOS 备份解析真机验证

- 已实现 Safari/Chrome 备份解析逻辑并有单元测试，但仍需要在真实 iOS 设备完成备份后验证：
  - Manifest.db 表结构差异
  - History.db 表结构差异
  - 加密备份的处理策略（不做绕过）

### 3.3 Windows 原生安装器（EXE）本机未构建

- 仓库已提供 Inno Setup 脚本：`installer/windows/crypto-trace-inspector.iss`
- CI 已提供构建工作流：`.github/workflows/build-installers.yml`（tag `v*` 触发）
- 已补充 CI 冒烟测试（安装 -> 启动 `inspector-desktop --ui none` -> `/api/health` -> 卸载）：
  - 脚本：`scripts/windows/installer_smoke_test.ps1`
  - 目的：尽早发现“安装包缺文件/启动失败/端口监听失败”等问题
- 仍建议在 Windows 真机做一次手工验收（开始菜单/桌面快捷方式、升级覆盖、杀软/SmartScreen 体验）。

---

## 4. 结论

当前版本已形成“主机采集 -> 命中 -> 证据 -> 审计 -> 报告 -> 司法导出 ZIP -> 离线校验”的闭环，并补齐了链上余额查询（含写入证据链的留痕能力）。移动端交易所访问检测已接入 iOS 备份解析（Safari/Chrome）与 Android best effort 采集路径，但仍需要在真机/授权条件下进一步做兼容性验证与覆盖面完善。
